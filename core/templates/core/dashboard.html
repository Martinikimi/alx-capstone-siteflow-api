<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SiteFlow - Construction Management</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .hidden { display: none; }
        .card { background: white; padding: 20px; margin: 10px 0; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .btn { padding: 10px 15px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-success { background: #28a745; color: white; }
        .form-group { margin: 10px 0; }
        label { display: block; margin-bottom: 5px; }
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .debug-info { background: #fff3cd; padding: 10px; border-radius: 5px; margin: 10px 0; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <header>
        <h1>üèóÔ∏è SiteFlow</h1>
        <div>
            <span id="userEmail">Not logged in</span>
            <span id="userRoleBadge" style="background: #6c757d; color: white; padding: 2px 8px; border-radius: 10px; margin: 0 10px;"></span>
            <button id="loginBtn" class="btn btn-primary" onclick="showSection('login')">Login</button>
            <button id="logoutBtn" class="btn btn-danger hidden" onclick="logout()">Logout</button>
        </div>
    </header>

    <nav style="margin: 20px 0;">
        <button onclick="showSection('dashboard')">Dashboard</button>
        <button onclick="showSection('projects')">Projects</button>
        <button onclick="showSection('issues')">Issues</button>
        <button onclick="showSection('trades')" id="tradesNavBtn" class="hidden">üîß Trades</button>
        <button onclick="showSection('users')" id="usersNavBtn" class="hidden">üë• Users</button>
        <button onclick="showDebugInfo()" class="btn" style="background: #ffc107;">üêõ Debug</button>
    </nav>

    <main>
        <!-- Login Section -->
        <section id="login-section">
            <div class="card" style="max-width: 400px;">
                <h2>Login</h2>
                <form id="loginForm">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="loginEmail" required>
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="loginPassword" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Login</button>
                </form>
                <p>Don't have an account? <a href="#" onclick="showSection('register')">Register</a></p>
            </div>
        </section>

        <!-- Register Section -->
        <section id="register-section" class="hidden">
            <div class="card" style="max-width: 500px;">
                <h2>Register</h2>
                <form id="registerForm">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div class="form-group">
                            <label>Username</label>
                            <input type="text" id="regUsername" required>
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="regEmail" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="regPassword" required>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div class="form-group">
                            <label>Role</label>
                            <select id="regRole" required onchange="toggleSpecialtyField()">
                                <option value="">Select Role</option>
                                <option value="PROJECT MANAGER">Project Manager</option>
                                <option value="SITE OFFICER">Site Officer</option>
                                <option value="SUB CONTRACTOR">Sub Contractor</option>
                                <option value="SAFETY OFFICER">Safety Officer</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Specialty</label>
                            <select id="regSpecialty">
                                <option value="">Select Specialty</option>
                                <option value="GENERAL">General</option>
                                <option value="ARCHITECTURAL">Architectural</option>
                                <option value="STRUCTURAL">Structural</option>
                                <option value="ELECTRICAL">Electrical</option>
                                <option value="MECHANICAL">Mechanical</option>
                                <option value="PLUMBING">Plumbing</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Register</button>
                </form>
                <p>Already have an account? <a href="#" onclick="showSection('login')">Login</a></p>
            </div>
        </section>

        <!-- Dashboard Section -->
        <section id="dashboard-section" class="hidden">
            <h2>Dashboard - <span id="dashboardRoleInfo"></span></h2>
            
            <div id="debugDashboardInfo" class="debug-info hidden">
                <strong>Debug Info:</strong>
                <div id="debugDashboardContent"></div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin: 20px 0;">
                <div class="card">
                    <h3 id="projectCount">0</h3>
                    <p>Total Projects</p>
                </div>
                <div class="card">
                    <h3 id="openIssuesCount">0</h3>
                    <p>Open Issues</p>
                </div>
                <div class="card">
                    <h3 id="myIssuesCount">0</h3>
                    <p>My Issues</p>
                </div>
                <div class="card">
                    <h3 id="highPriorityCount">0</h3>
                    <p>High Priority</p>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div class="card">
                    <h3>Recent Issues</h3>
                    <div id="recentIssues">Loading...</div>
                </div>
                <div class="card">
                    <h3>My Projects</h3>
                    <div id="myProjects">Loading...</div>
                </div>
            </div>
        </section>

        <!-- Projects Section -->
        <section id="projects-section" class="hidden">
            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 20px;">
                <h2>Projects - <span id="projectsRoleInfo"></span></h2>
                <div>
                    <button class="btn btn-primary" id="createProjectBtn" onclick="showCreateProjectForm()">+ New Project</button>
                    <button class="btn btn-success" id="assignUsersBtn" onclick="showSection('users')">üë• Assign Users</button>
                </div>
            </div>

            <div id="debugProjectsInfo" class="debug-info hidden">
                <strong>Debug Info:</strong>
                <div id="debugProjectsContent"></div>
            </div>

            <div class="card hidden" id="createProjectForm">
                <h3>Create New Project</h3>
                <form id="projectForm">
                    <div class="form-group">
                        <label>Project Name</label>
                        <input type="text" id="projectName" required>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="projectDescription" rows="3" required></textarea>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div class="form-group">
                            <label>Start Date</label>
                            <input type="date" id="startDate" required>
                        </div>
                        <div class="form-group">
                            <label>End Date</label>
                            <input type="date" id="endDate" required>
                        </div>
                    </div>
                    <div>
                        <button type="button" class="btn" onclick="hideCreateProjectForm()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Create Project</button>
                    </div>
                </form>
            </div>

            <div id="projectsList">Loading projects...</div>
        </section>

        <!-- Other sections remain the same but with debug info added -->
        <!-- Issues, Trades, Users sections... -->

    </main>

    <script>
        // API Configuration
        const API_BASE = 'http://localhost:8000/api';
        let currentUser = null;
        let authToken = localStorage.getItem('authToken');
        let debugMode = false;

        // DOM Elements
        const sections = {
            login: document.getElementById('login-section'),
            register: document.getElementById('register-section'),
            dashboard: document.getElementById('dashboard-section'),
            projects: document.getElementById('projects-section'),
            issues: document.getElementById('issues-section'),
            trades: document.getElementById('trades-section'),
            users: document.getElementById('users-section')
        };

        // Initialize App
        document.addEventListener('DOMContentLoaded', function() {
            if (authToken) {
                checkAuth();
            } else {
                showSection('login');
            }
        });

        // API Functions
        async function apiCall(endpoint, options = {}) {
            const url = `${API_BASE}${endpoint}`;
            const config = {
                headers: {
                    'Content-Type': 'application/json',
                    ...options.headers
                },
                ...options
            };

            if (authToken) {
                config.headers.Authorization = `Bearer ${authToken}`;
            }

            try {
                console.log(`üîÑ API CALL: ${url}`, config);
                const response = await fetch(url, config);
                
                if (response.status === 204) {
                    return {};
                }
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.detail || data.error || 'API request failed');
                }
                
                console.log(`‚úÖ API SUCCESS: ${url}`, data);
                return data;
            } catch (error) {
                console.error(`‚ùå API ERROR: ${url}`, error);
                alert('Error: ' + error.message);
                throw error;
            }
        }

        // Auth Functions
        async function checkAuth() {
            try {
                const user = await apiCall('/auth/profile/');
                currentUser = user;
                console.log('üü¢ USER LOGGED IN:', user);
                updateUI();
                showSection('dashboard');
                loadDashboardData();
            } catch (error) {
                console.error('üî¥ AUTH FAILED:', error);
                localStorage.removeItem('authToken');
                authToken = null;
                showSection('login');
            }
        }

        // Project Functions - CRITICAL FIXES
        async function loadProjects() {
            try {
                console.log('üîÑ LOADING PROJECTS for user:', currentUser.email, 'role:', currentUser.role);
                
                const response = await apiCall('/projects/');
                let projects = response;
                if (response.results) {
                    projects = response.results;
                }
                
                console.log('üìã PROJECTS RESPONSE:', projects);
                
                // DEBUG INFO
                if (debugMode) {
                    const debugInfo = `
                        User: ${currentUser.email} (${currentUser.role})
                        Total Projects from API: ${projects.length}
                        Project Names: ${projects.map(p => p.project_name).join(', ')}
                        Project IDs: ${projects.map(p => p.id).join(', ')}
                    `;
                    document.getElementById('debugProjectsContent').innerHTML = debugInfo;
                    document.getElementById('debugProjectsInfo').classList.remove('hidden');
                }
                
                displayProjects(projects);
            } catch (error) {
                const errorMsg = `Error loading projects: ${error.message}`;
                console.error('‚ùå', errorMsg);
                document.getElementById('projectsList').innerHTML = `<p>${errorMsg}</p>`;
            }
        }

        function displayProjects(projects) {
            const container = document.getElementById('projectsList');
            
            if (!projects || projects.length === 0) {
                container.innerHTML = `
                    <div class="card">
                        <h3>No Projects Found</h3>
                        <p>You are not assigned to any projects.</p>
                        ${currentUser && currentUser.role === 'PROJECT MANAGER' ? 
                            '<p><button class="btn btn-primary" onclick="showCreateProjectForm()">Create your first project</button></p>' : 
                            '<p>Contact a Project Manager to get assigned to projects.</p>'}
                    </div>
                `;
                return;
            }

            container.innerHTML = projects.map(project => `
                <div class="card">
                    <h3>${project.project_name || 'Unnamed Project'}</h3>
                    <p>${project.description || 'No description'}</p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <strong>Start:</strong> ${project.start_date || 'N/A'}<br>
                            <strong>End:</strong> ${project.end_date || 'N/A'}
                        </div>
                        <div>
                            <strong>Assigned Users:</strong> 
                            ${project.assigned_users && project.assigned_users.length > 0 ? 
                                project.assigned_users.map(u => `
                                    <span style="display: block; font-size: 0.9rem;">
                                        ${u.email} ${u.email === currentUser.email ? '<strong>(YOU)</strong>' : ''}
                                    </span>
                                `).join('') : 
                                'None'}
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <button class="btn" onclick="viewProjectIssues(${project.id})">View Issues</button>
                        ${currentUser && currentUser.role === 'PROJECT MANAGER' ? 
                          `<button class="btn btn-success" onclick="quickAssignToProject(${project.id})">Assign Users</button>` : ''}
                    </div>
                </div>
            `).join('');
        }

        // Dashboard Functions with Debug
        async function loadDashboardData() {
            try {
                console.log('üîÑ LOADING DASHBOARD DATA for user:', currentUser.email);
                
                const [projectsResponse, issuesResponse] = await Promise.all([
                    apiCall('/projects/'),
                    apiCall('/issues/')
                ]);

                let projects = projectsResponse;
                let issues = issuesResponse;
                
                if (projectsResponse.results) {
                    projects = projectsResponse.results;
                }
                if (issuesResponse.results) {
                    issues = issuesResponse.results;
                }

                if (!Array.isArray(projects)) projects = [];
                if (!Array.isArray(issues)) issues = [];

                console.log('üìä DASHBOARD DATA:', {
                    projectsCount: projects.length,
                    projects: projects.map(p => p.project_name),
                    issuesCount: issues.length
                });

                // DEBUG INFO
                if (debugMode) {
                    const debugInfo = `
                        User: ${currentUser.email} (${currentUser.role})
                        Projects Visible: ${projects.length}
                        Project Names: ${projects.map(p => p.project_name).join(', ')}
                        All Issues: ${issues.length}
                        My Issues (calculated): ${calculateMyIssuesCount(issues)}
                    `;
                    document.getElementById('debugDashboardContent').innerHTML = debugInfo;
                    document.getElementById('debugDashboardInfo').classList.remove('hidden');
                }

                // Update stats
                document.getElementById('projectCount').textContent = projects.length;
                document.getElementById('openIssuesCount').textContent = issues.filter(i => i.status === 'OPEN').length;
                document.getElementById('myIssuesCount').textContent = calculateMyIssuesCount(issues);
                document.getElementById('highPriorityCount').textContent = issues.filter(i => 
                    i.priority === 'HIGH' || i.priority === 'CRITICAL'
                ).length;

                // Display recent issues
                const recentIssues = issues.slice(0, 5);
                document.getElementById('recentIssues').innerHTML = recentIssues.length > 0 ? 
                    recentIssues.map(issue => `
                        <div style="padding: 10px; border-bottom: 1px solid #ddd;">
                            <div style="display: flex; justify-content: space-between;">
                                <strong>${issue.issue_title}</strong>
                                <span style="background: ${getPriorityColor(issue.priority)}; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.8rem;">
                                    ${issue.priority}
                                </span>
                            </div>
                            <div style="font-size: 0.9rem; color: #666;">
                                ${issue.project_name || 'N/A'} ‚Ä¢ ${issue.trade} ‚Ä¢ ${issue.assigned_to_email || 'Unassigned'}
                            </div>
                        </div>
                    `).join('') : '<p>No recent issues</p>';

                // Display my projects
                const myProjects = projects.slice(0, 5);
                document.getElementById('myProjects').innerHTML = myProjects.length > 0 ? 
                    myProjects.map(project => `
                        <div style="padding: 10px; border-bottom: 1px solid #ddd;">
                            <strong>${project.project_name}</strong>
                            <div style="font-size: 0.9rem; color: #666;">
                                ${project.start_date} to ${project.end_date}
                            </div>
                        </div>
                    `).join('') : '<p>No projects</p>';

            } catch (error) {
                console.error('‚ùå DASHBOARD ERROR:', error);
            }
        }

        function calculateMyIssuesCount(issues) {
            if (!currentUser) return 0;
            
            if (currentUser.role === 'SUB CONTRACTOR' && currentUser.specialty) {
                return issues.filter(i => i.trade === currentUser.specialty && i.assigned_to_email === currentUser.email).length;
            } else if (currentUser.role === 'SAFETY OFFICER') {
                return issues.filter(i => i.priority === 'HIGH' || i.priority === 'CRITICAL').length;
            } else {
                return issues.length;
            }
        }

        function getPriorityColor(priority) {
            const colors = {
                'LOW': '#28a745',
                'MEDIUM': '#ffc107', 
                'HIGH': '#fd7e14',
                'CRITICAL': '#dc3545'
            };
            return colors[priority] || '#6c757d';
        }

        // Debug Functions
        function showDebugInfo() {
            debugMode = !debugMode;
            const debugElements = document.querySelectorAll('.debug-info');
            debugElements.forEach(el => {
                if (debugMode) {
                    el.classList.remove('hidden');
                } else {
                    el.classList.add('hidden');
                }
            });
            alert(`Debug mode ${debugMode ? 'ENABLED' : 'DISABLED'}`);
            
            // Reload current section to show debug info
            if (currentUser) {
                const currentSection = Object.keys(sections).find(key => !sections[key].classList.contains('hidden'));
                if (currentSection) {
                    showSection(currentSection);
                }
            }
        }

        // UI Functions
        function showSection(sectionName) {
            Object.values(sections).forEach(section => {
                section.classList.add('hidden');
            });
            sections[sectionName].classList.remove('hidden');
            
            if (sectionName === 'dashboard' && currentUser) {
                loadDashboardData();
            } else if (sectionName === 'projects' && currentUser) {
                loadProjects();
            } else if (sectionName === 'issues' && currentUser) {
                loadIssues();
            } else if (sectionName === 'trades' && currentUser) {
                loadTrades();
            } else if (sectionName === 'users' && currentUser) {
                loadProjectsForAssignment();
            }
        }

        function updateUI() {
            const userEmail = document.getElementById('userEmail');
            const userRoleBadge = document.getElementById('userRoleBadge');
            const loginBtn = document.getElementById('loginBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const createProjectBtn = document.getElementById('createProjectBtn');
            const assignUsersBtn = document.getElementById('assignUsersBtn');
            const tradesNavBtn = document.getElementById('tradesNavBtn');
            const usersNavBtn = document.getElementById('usersNavBtn');

            if (currentUser) {
                userEmail.textContent = currentUser.email;
                userRoleBadge.textContent = currentUser.role;
                loginBtn.classList.add('hidden');
                logoutBtn.classList.remove('hidden');
                
                // Show/hide features based on role
                const isProjectManager = currentUser.role === 'PROJECT MANAGER';
                createProjectBtn.style.display = isProjectManager ? 'block' : 'none';
                assignUsersBtn.style.display = isProjectManager ? 'inline-block' : 'none';
                tradesNavBtn.style.display = isProjectManager ? 'inline-block' : 'none';
                usersNavBtn.style.display = isProjectManager ? 'inline-block' : 'none';
                
                // Update role info
                document.getElementById('dashboardRoleInfo').textContent = currentUser.role;
                document.getElementById('projectsRoleInfo').textContent = currentUser.role;
                document.getElementById('issuesRoleInfo').textContent = currentUser.role;
                
                console.log('üéØ UI UPDATED for role:', currentUser.role);
                
            } else {
                userEmail.textContent = 'Not logged in';
                userRoleBadge.textContent = '';
                loginBtn.classList.remove('hidden');
                logoutBtn.classList.add('hidden');
            }
        }

        // ... Rest of your existing functions (login, register, etc.)

        // TEST FUNCTION - Use this to verify the filtering
        async function testProjectFiltering() {
            console.log('üß™ TESTING PROJECT FILTERING');
            console.log('Current User:', currentUser);
            
            const projects = await apiCall('/projects/');
            console.log('Projects returned:', projects);
            
            alert(`TEST RESULTS:
User: ${currentUser.email} (${currentUser.role})
Projects Visible: ${projects.length}
Project Names: ${projects.map(p => p.project_name).join(', ')}
            `);
        }

    </script>
</body>
</html>